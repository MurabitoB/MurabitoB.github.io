{"title":"Entity Framework Identity 插入資料時自動獲得id","uid":"4b75f77a6376da79907037a67ad42fb0","slug":"Entityframework-Identity","date":"2020-11-23T16:00:00.000Z","updated":"2022-08-19T01:08:59.331Z","comments":true,"path":"api/articles/Entityframework-Identity.json","keywords":null,"cover":null,"content":"<h2 id=\"EntityFramework-Identity-插入資料時自動獲得id\"><a href=\"#EntityFramework-Identity-插入資料時自動獲得id\" class=\"headerlink\" title=\"EntityFramework Identity 插入資料時自動獲得id\"></a>EntityFramework Identity 插入資料時自動獲得id</h2><h3 id=\"環境\"><a href=\"#環境\" class=\"headerlink\" title=\"環境\"></a>環境</h3><ul>\n<li>Visual Studio 2019</li>\n<li>.Net Framework : 4.7.2</li>\n<li>Entity Framework : 6.4.4</li>\n<li>MySql.Data.EntityFramework: 8.0.18</li>\n<li>DB : MariadDB</li>\n</ul>\n<hr>\n<h3 id=\"問題\"><a href=\"#問題\" class=\"headerlink\" title=\"問題\"></a>問題</h3><p>在專案上有需要MariadDB的Table做資料維護，而Database是甲方爸爸開的，所以是必須以Database First的模式開發。</p>\n<p>甲方爸爸的欄位皆以int做主鍵id並以auto increment做欄位的自動增值。  </p>\n<p>資料維護需要以Ajax的方式在新增之後馬上顯示在前端的頁面中，<br>被新增的資料有可能在同頁面中馬上被刪除，因此需要新增資料後要馬上取得該欄位的id並回傳給前端。  </p>\n<p>此外在插入資料的時候，並沒有直接指定值，而是由資料庫自動產生對應的id，這就造成了無法知道生成的資料的id。</p>\n<h3 id=\"解法\"><a href=\"#解法\" class=\"headerlink\" title=\"解法\"></a>解法</h3><p>Entity Framework會依照映射的模型有沒有identity欄位來決定新增後會不會自動取值回來。</p>\n<p>可以透過Entity Framework的Log的Action去指定輸出生成的SQL語法用的method來觀察轉換出來的SQL語法</p>\n<pre class=\"line-numbers language-C#\" data-language=\"C#\"><code class=\"language-C#\">context.Database.Log &#x3D; Console.WriteLine;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>在INSERT後端包含了SELECT的語法，並且由於對應的資料庫是MariadDB，所以輸出的SQL CODE中用到了MySQL的 last_insert_id()的函式，如果環境是對應到Sql Server，那生成的sql code會變成 scope_identity()。</p>\n<pre class=\"line-numbers language-SQL\" data-language=\"SQL\"><code class=\"language-SQL\">SELECT\n&#96;sid&#96;\nFROM &#96;target_data&#96;\nWHERE  row_count() &gt; 0 AND &#96;sid&#96;&#x3D; last_insert_id()<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<h3 id=\"參考資料：\"><a href=\"#參考資料：\" class=\"headerlink\" title=\"參考資料：\"></a>參考資料：</h3><p><a href=\"https://blog.csdn.net/wangzl1163/article/details/52037714\">https://blog.csdn.net/wangzl1163/article/details/52037714</a><br><a href=\"https://dotblogs.com.tw/yc421206/2020/06/27/ef_insert_after_query_identity_field\">https://dotblogs.com.tw/yc421206/2020/06/27/ef_insert_after_query_identity_field</a></p>\n","text":"EntityFramework Identity 插入資料時自動獲得id環境 Visual Studio 2019 .Net Framework : 4.7.2 Entity Framework : 6.4.4 MySql.Data.EntityFramework: 8.0.18...","link":"","photos":[],"count_time":{"symbolsCount":980,"symbolsTime":"1 mins."},"categories":[{"name":"程式開發","slug":"程式開發","count":5,"path":"api/categories/程式開發.json"}],"tags":[{"name":".Net Framewrok","slug":"Net-Framewrok","count":1,"path":"api/tags/Net-Framewrok.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#EntityFramework-Identity-%E6%8F%92%E5%85%A5%E8%B3%87%E6%96%99%E6%99%82%E8%87%AA%E5%8B%95%E7%8D%B2%E5%BE%97id\"><span class=\"toc-text\">EntityFramework Identity 插入資料時自動獲得id</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E7%92%B0%E5%A2%83\"><span class=\"toc-text\">環境</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%95%8F%E9%A1%8C\"><span class=\"toc-text\">問題</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%A7%A3%E6%B3%95\"><span class=\"toc-text\">解法</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99%EF%BC%9A\"><span class=\"toc-text\">參考資料：</span></a></li></ol></li></ol>","author":{"name":"MurabitoB","slug":"blog-author","avatar":"https://avatars1.githubusercontent.com/u/22661940?s=460&u=4cab0880b99fcb3784e73bc6550039106c2ba83e&v=4","link":"/","description":"後端軟體工程師<br>業餘Unity工程師<br>獨立遊戲開發","socials":{"github":"https://github.com/MurabitoB","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"linkedin":{"icon":"fab fa-linkedin","link":"https://www.linkedin.com/in/kai-sheng-liu-b209781b4/"}}}},"mapped":true,"prev_post":{"title":".Net Core Dependency Injection Scoped 注入到 Singleton","uid":"98c01dec7a830e04805e721a8c540f17","slug":"dotnet-core-scoped-in-singleton","date":"2021-06-16T16:00:00.000Z","updated":"2022-08-19T01:08:59.331Z","comments":true,"path":"api/articles/dotnet-core-scoped-in-singleton.json","keywords":null,"cover":null,"text":"環境 .Net Core 3.1 問題踩雷． 在專案中如果想對 Singleton 的 Service 中直接注入 Scoped 的 Service 的話，會拋出 Exception 下面範例取自黑暗執行緒 System.AggregateException: 'Some ser...","link":"","photos":[],"count_time":{"symbolsCount":"1.2k","symbolsTime":"1 mins."},"categories":[{"name":"程式開發","slug":"程式開發","count":5,"path":"api/categories/程式開發.json"}],"tags":[{"name":".Net Core","slug":"Net-Core","count":1,"path":"api/tags/Net-Core.json"},{"name":"Dependency Injection","slug":"Dependency-Injection","count":1,"path":"api/tags/Dependency-Injection.json"}],"author":{"name":"MurabitoB","slug":"blog-author","avatar":"https://avatars1.githubusercontent.com/u/22661940?s=460&u=4cab0880b99fcb3784e73bc6550039106c2ba83e&v=4","link":"/","description":"後端軟體工程師<br>業餘Unity工程師<br>獨立遊戲開發","socials":{"github":"https://github.com/MurabitoB","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"linkedin":{"icon":"fab fa-linkedin","link":"https://www.linkedin.com/in/kai-sheng-liu-b209781b4/"}}}}},"next_post":{}}